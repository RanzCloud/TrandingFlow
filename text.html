<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RanzTrading Ultimate V3 - Indodax & Stockbit Style</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' },
                        brand: { blue: '#3b82f6', accent: '#06b6d4', success: '#10b981', danger: '#ef4444' },
                        indodax: { bg: '#0f1216', card: '#1b1e26', up: '#0ecb81', down: '#f6465d' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] },
                    animation: { 'fade-up': 'fadeUp 0.4s ease-out forwards', 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    keyframes: { fadeUp: { '0%': { opacity: 0, transform: 'translateY(10px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Glass & Panels */
        .glass-panel { background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        html:not(.dark) .glass-panel { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0, 0, 0, 0.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Indodax Style Table */
        .crypto-table tr { border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; }
        .crypto-table tr:hover { background: rgba(255,255,255,0.05); }
        
        /* Stockbit Style Grid */
        .stock-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stock-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .stock-card.up { border-left: 4px solid #0ecb81; }
        .stock-card.down { border-left: 4px solid #f6465d; }

        /* Inputs & Utilities */
        .glass-input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.2s; }
        html:not(.dark) .glass-input { background: #fff; border: 1px solid #e2e8f0; color: #1e293b; }
        .glass-input:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        
        .hidden-screen { display: none !important; }
        .text-up { color: #0ecb81; } /* Indodax Green */
        .text-down { color: #f6465d; } /* Indodax Red */
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .nav-active { color: #3b82f6; }
        .nav-active svg { stroke-width: 2.5px; transform: translateY(-2px); }
    </style>
</head>
<body class="bg-slate-950 dark:bg-slate-950 bg-slate-50 text-slate-200 dark:text-slate-200 text-slate-800 antialiased h-screen overflow-hidden flex flex-col transition-colors duration-300">

    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>
    <div id="app" class="flex-1 flex flex-col relative w-full h-full"></div>

    <script>
        // --- KONFIGURASI DATABASE V3 ---
        const DB_KEYS = { USERS: 'rt_users_v4', POSTS: 'rt_posts_v4', SETTINGS: 'rt_settings_v4', SESSION: 'rt_session_v4' };
        
        // Data Admin
        const ADMIN_USER = {
            id: 'admin_001', username: 'RanzTranding', fullName: 'Ranz Admin',
            email: 'admin@ranztrading.com', password: 'Ranzcode21', pin: '123456',
            isVerified: true, isBanned: false, balance: 999999999,
            avatar: 'https://ui-avatars.com/api/?name=Ranz+Admin&background=3b82f6&color=fff',
            bio: 'Super Admin.', role: 'admin'
        };

        // Data Market Simulation (Top LQ45 & Crypto)
        const MARKET_DATA = {
            crypto: [
                {id:'BTC', name:'Bitcoin', price: 945000000, change: 2.4}, {id:'ETH', name:'Ethereum', price: 48000000, change: -1.2},
                {id:'SOL', name:'Solana', price: 3200000, change: 5.6}, {id:'BNB', name:'Binance', price: 9800000, change: 0.5},
                {id:'XRP', name:'Ripple', price: 9200, change: -0.8}, {id:'ADA', name:'Cardano', price: 8500, change: 1.1},
                {id:'DOGE', name:'Dogecoin', price: 1500, change: 12.4}, {id:'DOT', name:'Polkadot', price: 78000, change: -3.2}
            ],
            idx: [
                {id:'BBCA', name:'Bank Central Asia', price: 9250, change: 1.25}, {id:'BBRI', name:'Bank Rakyat Indo', price: 5400, change: -0.5},
                {id:'TLKM', name:'Telkom Indonesia', price: 3650, change: 0.0}, {id:'ASII', name:'Astra International', price: 5800, change: 0.8},
                {id:'ICBP', name:'Indofood CBP', price: 11200, change: 2.1}, {id:'UNVR', name:'Unilever Indo', price: 3100, change: -1.5},
                {id:'GOTO', name:'GoTo Gojek Tokopedia', price: 86, change: 5.4}, {id:'ADRO', name:'Adaro Energy', price: 2600, change: -2.3},
                {id:'ANTM', name:'Aneka Tambang', price: 2750, change: 3.0}, {id:'HRUM', name:'Harum Energy', price: 1500, change: 0.5}
            ]
        };

        const AppState = {
            currentUser: null,
            currentView: 'login', 
            dashView: 'feed', // feed, crypto, idx, news, profile, admin
            apiKeys: { stock: '', crypto: '', news: '' }, 
            chartInstance: null,
            tempPostImage: null,
            tempAvatar: null,
            marketInterval: null
        };

        // --- DB HELPER ---
        const db = {
            get: (k) => JSON.parse(localStorage.getItem(k) || '[]'),
            set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
            init: () => {
                let users = db.get(DB_KEYS.USERS);
                if (!users.find(u => u.username === ADMIN_USER.username)) {
                    users.push(ADMIN_USER);
                    db.set(DB_KEYS.USERS, users);
                }
                // Load Settings & API Keys
                const sets = JSON.parse(localStorage.getItem(DB_KEYS.SETTINGS) || '{}');
                AppState.apiKeys = { stock: sets.stock||'', crypto: sets.crypto||'', news: sets.news||'' };
                
                // Seed Posts
                if(db.get(DB_KEYS.POSTS).length === 0) {
                    db.set(DB_KEYS.POSTS, [{id:1, userId:ADMIN_USER.id, content:'Update V3: Market Real-time & Berita Aktif! $IHSG ðŸš€', timestamp:Date.now(), likes:120}]);
                }
            }
        };
        db.init();

        // --- AUTH & BAN CHECK ---
        const session = db.get(DB_KEYS.USERS).find(u => u.id === localStorage.getItem(DB_KEYS.SESSION));
        if(session) { 
            if(session.isBanned) {
                localStorage.removeItem(DB_KEYS.SESSION);
                alert('AKUN ANDA TELAH DIBANNED OLEH ADMIN!');
                location.reload();
            }
            AppState.currentUser = session; 
            AppState.currentView = session.role === 'admin' ? 'admin' : 'dashboard'; 
        }

        // --- LOGIC FUNCTIONS ---
        
        function handleRegister(e) {
            e.preventDefault();
            const f = e.target;
            const users = db.get(DB_KEYS.USERS);
            if(users.find(u => u.username === f.username.value)) return showToast('Username dipakai', 'error');
            AppState.tempReg = { username:f.username.value, name:f.fullName.value, email:f.email.value, pass:f.password.value };
            AppState.currentView = 'pin-setup';
            render();
        }
        function handlePinSetup(e) {
            e.preventDefault();
            const users = db.get(DB_KEYS.USERS);
            users.push({
                id: 'u_'+Date.now(), username:AppState.tempReg.username, fullName:AppState.tempReg.name,
                email:AppState.tempReg.email, password:AppState.tempReg.pass, pin:e.target.pin.value,
                isVerified:false, isBanned:false, balance: 10000000, // Saldo awal 10 Juta
                avatar:`https://ui-avatars.com/api/?name=${AppState.tempReg.username}&bg=334155&color=fff`,
                role:'user', bio:'New Trader'
            });
            db.set(DB_KEYS.USERS, users);
            showToast('Registrasi Berhasil! Saldo Awal Rp 10 Juta.', 'success');
            AppState.currentView = 'login';
            render();
        }
        function handleLogin(e) {
            e.preventDefault();
            const user = db.get(DB_KEYS.USERS).find(u => u.username === e.target.loginId.value && u.password === e.target.password.value);
            if(!user) return showToast('Data salah', 'error');
            if(user.isBanned) return showToast('Akun Anda Dibanned', 'error');
            AppState.tempLogin = user;
            AppState.currentView = 'pin-verify';
            render();
        }
        function handlePinVerify(e) {
            if(e.target.pin.value !== AppState.tempLogin.pin) return showToast('PIN Salah', 'error');
            localStorage.setItem(DB_KEYS.SESSION, AppState.tempLogin.id);
            AppState.currentUser = AppState.tempLogin;
            AppState.currentView = AppState.currentUser.role === 'admin' ? 'admin' : 'dashboard';
            showToast('Login Berhasil', 'success');
            render();
        }
        function logout() {
            clearInterval(AppState.marketInterval); // Stop ticker
            localStorage.removeItem(DB_KEYS.SESSION);
            AppState.currentUser = null;
            AppState.currentView = 'login';
            render();
        }

        function switchView(v) { AppState.currentView = v; render(); }
        function switchDash(v) { 
            AppState.dashView = v; 
            clearInterval(AppState.marketInterval); // Reset ticker on tab switch
            render();
            // Start Realtime Simulation if Crypto or IDX
            if(v === 'crypto' || v === 'idx') startMarketSimulator();
        }

        function startMarketSimulator() {
            if(AppState.marketInterval) clearInterval(AppState.marketInterval);
            AppState.marketInterval = setInterval(() => {
                if(!AppState.apiKeys.crypto && !AppState.apiKeys.stock) return; // Only run if API Key "exists" (Simulated)
                
                // Update DOM elements directly for performance
                document.querySelectorAll('.live-price').forEach(el => {
                    const current = parseFloat(el.getAttribute('data-price'));
                    const change = (Math.random() - 0.5) * (current * 0.002); // 0.2% fluctuation
                    const newVal = current + change;
                    el.setAttribute('data-price', newVal);
                    el.innerText = formatCurrency(newVal, el.getAttribute('data-type') === 'crypto');
                    
                    // Flash effect
                    el.style.color = change > 0 ? '#0ecb81' : '#f6465d';
                    setTimeout(() => el.style.color = '', 500);
                });
            }, 2000); // Update every 2 seconds
        }

        function formatCurrency(val, isCrypto) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: isCrypto ? 0 : 0 }).format(val);
        }

        function toggleTheme() { document.documentElement.classList.toggle('dark'); render(); }
        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            const bg = type==='error'?'bg-red-500':(type==='success'?'bg-green-500':'bg-blue-500');
            t.className = `${bg} text-white px-4 py-3 rounded-lg shadow-xl animate-fade-up text-sm font-medium flex items-center gap-2`;
            t.innerHTML = type==='success'?'<i data-lucide="check" class="w-4 h-4"></i>'+msg:msg;
            c.appendChild(t); lucide.createIcons();
            setTimeout(()=>t.remove(),3000);
        }

        // --- IMAGE & POST ---
        function previewPostImage(event) {
            const file = event.target.files[0];
            if(file) {
                if(file.size > 400000) return showToast('Maksimal 400KB', 'error');
                const reader = new FileReader();
                reader.onload = (e) => {
                    AppState.tempPostImage = e.target.result;
                    const imgDiv = document.getElementById('preview-container');
                    imgDiv.innerHTML = `<img src="${e.target.result}" class="w-full h-40 object-cover rounded-lg mb-2"><button type="button" onclick="clearPostImage()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                    imgDiv.classList.remove('hidden');
                    imgDiv.classList.add('relative');
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            }
        }
        function clearPostImage() {
            AppState.tempPostImage = null;
            document.getElementById('postImageInput').value = '';
            document.getElementById('preview-container').innerHTML = '';
            document.getElementById('preview-container').classList.add('hidden');
        }
        function createPost() {
            const txt = document.getElementById('postText').value;
            if(!txt && !AppState.tempPostImage) return showToast('Isi teks atau foto', 'error');
            const posts = db.get(DB_KEYS.POSTS);
            posts.unshift({
                id: Date.now(), userId: AppState.currentUser.id, content: txt,
                image: AppState.tempPostImage, timestamp: Date.now(), likes: 0
            });
            try {
                db.set(DB_KEYS.POSTS, posts);
                AppState.tempPostImage = null;
                document.getElementById('postText').value = ''; clearPostImage();
                showToast('Posting Berhasil', 'success'); render();
            } catch(e) { showToast('Memori penuh', 'error'); }
        }

        // --- PROFILE & WITHDRAWAL ---
        function previewAvatar(event) {
            const file = event.target.files[0];
            if(file) {
                if(file.size > 300000) return showToast('Foto terlalu besar', 'error');
                const reader = new FileReader();
                reader.onload = (e) => { AppState.tempAvatar = e.target.result; document.getElementById('avatar-preview').src = e.target.result; };
                reader.readAsDataURL(file);
            }
        }
        function saveProfile() {
            const users = db.get(DB_KEYS.USERS);
            const idx = users.findIndex(u => u.id === AppState.currentUser.id);
            if(AppState.tempAvatar) AppState.currentUser.avatar = AppState.tempAvatar;
            AppState.currentUser.fullName = document.getElementById('pName').value;
            AppState.currentUser.email = document.getElementById('pEmail').value;
            if(document.getElementById('pPass').value) AppState.currentUser.password = document.getElementById('pPass').value;
            if(document.getElementById('pPin').value) AppState.currentUser.pin = document.getElementById('pPin').value;
            users[idx] = AppState.currentUser;
            db.set(DB_KEYS.USERS, users);
            showToast('Profil Disimpan', 'success');
            render();
        }
        function requestWithdrawal() {
            const amount = document.getElementById('wdAmount').value;
            const bank = document.getElementById('wdBank').value;
            const num = parseInt(amount);
            
            if(!num || num <= 0) return showToast('Jumlah tidak valid', 'error');
            if(num > AppState.currentUser.balance) return showToast('Saldo tidak cukup', 'error');
            
            AppState.currentUser.balance -= num;
            const users = db.get(DB_KEYS.USERS);
            const idx = users.findIndex(u => u.id === AppState.currentUser.id);
            users[idx] = AppState.currentUser;
            db.set(DB_KEYS.USERS, users);
            
            showToast(`Pencairan Rp ${num.toLocaleString()} ke ${bank} Berhasil!`, 'success');
            render();
        }

        // --- ADMIN FUNCTIONS ---
        function toggleUserStatus(userId) {
            const users = db.get(DB_KEYS.USERS);
            const idx = users.findIndex(u => u.id === userId);
            if(idx > -1 && users[idx].role !== 'admin') {
                users[idx].isBanned = !users[idx].isBanned;
                db.set(DB_KEYS.USERS, users);
                showToast(`User ${users[idx].isBanned ? 'Dibanned' : 'Unbanned'}`, 'success');
                render();
            }
        }
        function saveAdminSettings() {
            const sets = {
                stock: document.getElementById('kStock').value,
                crypto: document.getElementById('kCrypto').value,
                news: document.getElementById('kNews').value
            };
            localStorage.setItem(DB_KEYS.SETTINGS, JSON.stringify(sets));
            AppState.apiKeys = sets;
            showToast('Konfigurasi Disimpan', 'success');
        }

        // --- RENDER ENGINE ---
        const AuthView = () => `
            <div class="flex items-center justify-center min-h-screen p-4 bg-slate-950 dark:bg-slate-950 bg-slate-100">
                <div class="glass-panel p-6 rounded-2xl w-full max-w-md shadow-2xl animate-fade-up relative">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-cyan-500"></div>
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-500/20 mb-2"><i data-lucide="trending-up" class="w-6 h-6 text-blue-500"></i></div>
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">RanzTrading</h1>
                    </div>
                    ${AppState.currentView==='login'?getLoginForm():AppState.currentView==='register'?getRegForm():AppState.currentView==='pin-setup'?getPinForm('Set PIN','Daftar'):getPinForm('Masukan PIN','Masuk')}
                    <div class="mt-4 text-center text-xs text-slate-500">
                        ${AppState.currentView==='login'?'Belum punya akun? <button onclick="switchView(\'register\')" class="text-blue-500 font-bold">Daftar</button>':'Sudah punya akun? <button onclick="switchView(\'login\')" class="text-blue-500 font-bold">Login</button>'}
                    </div>
                </div>
            </div>`;
        function getLoginForm(){return `<form onsubmit="handleLogin(event)" class="space-y-4"><input name="loginId" placeholder="Username" class="w-full glass-input rounded-lg px-4 py-3" required><input type="password" name="password" placeholder="Password" class="w-full glass-input rounded-lg px-4 py-3" required><button class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg">Login</button></form>`;}
        function getRegForm(){return `<form onsubmit="handleRegister(event)" class="space-y-4"><input name="fullName" placeholder="Nama Lengkap" class="w-full glass-input rounded-lg px-4 py-3" required><input name="username" placeholder="Username" class="w-full glass-input rounded-lg px-4 py-3" required><input name="email" placeholder="Email" class="w-full glass-input rounded-lg px-4 py-3" required><input type="password" name="password" placeholder="Password" class="w-full glass-input rounded-lg px-4 py-3" required><button class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg shadow-lg">Daftar</button></form>`;}
        function getPinForm(t,b){return `<h3 class="text-center font-bold text-slate-900 dark:text-white mb-4">${t}</h3><form onsubmit="${AppState.currentView==='pin-setup'?'handlePinSetup':'handlePinVerify'}(event)"><input type="text" name="pin" maxlength="6" pattern="\\d{6}" class="w-full text-center text-2xl tracking-[0.5em] glass-input rounded-lg px-4 py-3 font-mono" placeholder="000000" required><button class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg mt-4">${b}</button></form>`;}

        const Dashboard = () => `
            <div class="flex h-screen bg-slate-50 dark:bg-slate-950 overflow-hidden relative">
                
                <!-- DESKTOP SIDEBAR -->
                <aside class="hidden md:flex flex-col w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 z-20">
                    <div class="p-6 flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold">R</div>
                        <span class="font-bold text-lg text-slate-900 dark:text-white">RanzTrading</span>
                    </div>
                    <nav class="flex-1 px-3 space-y-1 mt-4">
                        ${getDesktopLinks()}
                    </nav>
                    <div class="p-4 border-t border-slate-200 dark:border-slate-800 space-y-2">
                        <button onclick="toggleTheme()" class="w-full flex items-center gap-3 px-2 py-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i><i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i> Tema</button>
                        <button onclick="logout()" class="w-full flex items-center gap-3 px-2 py-2 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 font-bold"><i data-lucide="log-out" class="w-5 h-5"></i> Logout</button>
                    </div>
                </aside>

                <!-- MAIN CONTENT -->
                <main class="flex-1 flex flex-col h-full relative pt-14 md:pt-0 pb-20 md:pb-0 overflow-hidden">
                    <div class="md:hidden fixed top-0 w-full z-30 bg-white/90 dark:bg-slate-900/90 backdrop-blur border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex justify-between items-center">
                        <div class="font-bold text-lg text-slate-900 dark:text-white">RanzTrading</div>
                        <button onclick="switchDash('profile')" class="p-2"><img src="${AppState.currentUser.avatar}" class="w-8 h-8 rounded-full bg-slate-700"></button>
                    </div>

                    <div class="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-6 scroll-smooth no-scrollbar" id="main-scroll">
                        ${getDashContent()}
                    </div>

                    <!-- MOBILE BOTTOM NAV -->
                    <nav class="md:hidden fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 flex justify-around items-center py-3 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                        <button onclick="switchDash('feed')" class="flex flex-col items-center gap-1 ${AppState.dashView==='feed'?'nav-active':'text-slate-400'}"><i data-lucide="home" class="w-6 h-6"></i><span class="text-[10px] font-medium">Home</span></button>
                        <button onclick="switchDash('crypto')" class="flex flex-col items-center gap-1 ${AppState.dashView==='crypto'?'nav-active':'text-slate-400'}"><i data-lucide="bitcoin" class="w-6 h-6"></i><span class="text-[10px] font-medium">Crypto</span></button>
                        <button onclick="switchDash('idx')" class="flex flex-col items-center gap-1 ${AppState.dashView==='idx'?'nav-active':'text-slate-400'}"><i data-lucide="globe" class="w-6 h-6"></i><span class="text-[10px] font-medium">IDX</span></button>
                        <button onclick="switchDash('news')" class="flex flex-col items-center gap-1 ${AppState.dashView==='news'?'nav-active':'text-slate-400'}"><i data-lucide="newspaper" class="w-6 h-6"></i><span class="text-[10px] font-medium">Berita</span></button>
                        <button onclick="switchDash('profile')" class="flex flex-col items-center gap-1 ${AppState.dashView==='profile'?'nav-active':'text-slate-400'}"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px] font-medium">Profil</span></button>
                        ${AppState.currentUser.role === 'admin' ? `<button onclick="switchDash('admin')" class="flex flex-col items-center gap-1 ${AppState.dashView==='admin'?'nav-active':'text-purple-500'}"><i data-lucide="shield" class="w-6 h-6"></i><span class="text-[10px] font-medium">Admin</span></button>` : ''}
                    </nav>
                </main>
            </div>
        `;

        function getDesktopLinks() {
            const links = [
                {id:'feed', icon:'home', label:'Komunitas'},
                {id:'crypto', icon:'bitcoin', label:'Crypto (Indodax)'},
                {id:'idx', icon:'globe', label:'Saham IDX (Stockbit)'},
                {id:'news', icon:'newspaper', label:'Berita Pasar'},
            ];
            return links.map(l => `
                <button onclick="switchDash('${l.id}')" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition-all ${AppState.dashView===l.id?'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400':'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}">
                    <i data-lucide="${l.icon}" class="w-5 h-5"></i> ${l.label}
                </button>
            `).join('') + (AppState.currentUser.role === 'admin' ? `
                <button onclick="switchDash('admin')" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-bold text-purple-600 bg-purple-50 dark:bg-purple-900/20 mt-2"><i data-lucide="shield" class="w-5 h-5"></i> Admin Panel</button>
            ` : '');
        }

        function getDashContent(){
            setTimeout(()=>lucide.createIcons(), 50);
            setTimeout(()=>initCharts(), 100);
            switch(AppState.dashView) {
                case 'feed': return getFeed();
                case 'crypto': return getCryptoDashboard();
                case 'idx': return getIdxDashboard();
                case 'news': return getNewsDashboard();
                case 'admin': return getAdminDashboard();
                case 'profile': return getProfile();
                default: return getFeed();
            }
        }

        // --- SUB VIEWS ---

        function getFeed() {
            const posts = db.get(DB_KEYS.POSTS).sort((a,b)=>b.timestamp-a.timestamp);
            return `
                <div class="max-w-2xl mx-auto animate-fade-up pb-4">
                    <h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Komunitas Trader</h2>
                    <div class="glass-panel p-4 rounded-xl border border-slate-200 dark:border-slate-800 mb-6">
                        <div id="preview-container" class="hidden mb-2"></div>
                        <textarea id="postText" class="w-full bg-transparent border-none focus:ring-0 text-slate-900 dark:text-white placeholder-slate-500 resize-none h-20" placeholder="Analisis pasar Anda... $BTC $BBCA"></textarea>
                        <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-700/50">
                            <label class="cursor-pointer text-blue-400 hover:text-blue-300 flex items-center gap-1 text-sm font-bold">
                                <i data-lucide="image" class="w-5 h-5"></i> Foto
                                <input type="file" id="postImageInput" class="hidden" accept="image/*" onchange="previewPostImage(event)">
                            </label>
                            <button onclick="createPost()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg">Posting</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${posts.map(p=>{
                            const u = db.get(DB_KEYS.USERS).find(x=>x.id===p.userId)||{};
                            return `
                            <div class="glass-panel p-4 rounded-xl border border-slate-200 dark:border-slate-800">
                                <div class="flex gap-3 mb-2">
                                    <img src="${u.avatar||''}" class="w-10 h-10 rounded-full bg-slate-300 border border-slate-600">
                                    <div>
                                        <div class="font-bold text-slate-900 dark:text-white text-sm flex items-center gap-1">${u.username} ${u.isVerified?'<i data-lucide="badge-check" class="w-3 h-3 text-blue-500"></i>':''}</div>
                                        <div class="text-xs text-slate-500">${new Date(p.timestamp).toLocaleString()}</div>
                                    </div>
                                </div>
                                ${p.image ? `<img src="${p.image}" class="w-full rounded-lg mb-3 border border-slate-700 max-h-96 object-cover">` : ''}
                                <p class="text-slate-700 dark:text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">${p.content}</p>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }

        function getCryptoDashboard() {
            // Style Indodax: Dark, Dense Table
            return `
                <div class="animate-fade-up pb-4 max-w-4xl mx-auto">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Pasar Kripto</h2>
                            <span class="text-xs text-slate-500">Data Real-time (Indodax Style)</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500">BTC/IDR</div>
                            <div class="font-mono font-bold text-slate-900 dark:text-white live-price" data-price="${MARKET_DATA.crypto[0].price}" data-type="crypto">${formatCurrency(MARKET_DATA.crypto[0].price, true)}</div>
                        </div>
                    </div>
                    
                    <div class="glass-panel rounded-xl overflow-hidden border border-slate-200 dark:border-slate-800">
                        <table class="w-full text-left text-sm text-slate-400 crypto-table">
                            <thead class="bg-slate-100 dark:bg-slate-800 text-xs uppercase font-bold text-slate-700 dark:text-slate-300">
                                <tr>
                                    <th class="px-4 py-3">Nama</th>
                                    <th class="px-4 py-3">Harga Terakhir</th>
                                    <th class="px-4 py-3 text-right">24h %</th>
                                    <th class="px-4 py-3 text-right">Vol 24h</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                                ${MARKET_DATA.crypto.map(c => `
                                    <tr class="cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                        <td class="px-4 py-3 font-bold text-slate-900 dark:text-white">
                                            <div class="flex items-center gap-2">
                                                <div class="w-6 h-6 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-500 font-bold text-xs">${c.id[0]}</div>
                                                <div>${c.name} <span class="text-xs text-slate-500 font-normal">/${c.id}</span></div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 font-mono font-medium text-slate-900 dark:text-white live-price" data-price="${c.price}" data-type="crypto">${formatCurrency(c.price, true)}</td>
                                        <td class="px-4 py-3 text-right font-bold ${c.change >= 0 ? 'text-up' : 'text-down'}">${c.change > 0 ? '+' : ''}${c.change}%</td>
                                        <td class="px-4 py-3 text-right text-xs">${(Math.random()*100).toFixed(1)} Miliar</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        function getIdxDashboard() {
            // Style Stockbit: Cards, IHSG Chart
            return `
                <div class="animate-fade-up pb-4">
                    <div class="mb-4">
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-2">IHSG (Jakarta Composite)</h2>
                        <div class="glass-panel p-4 rounded-xl border border-slate-200 dark:border-slate-800 h-48 relative">
                            <div class="absolute top-2 left-4 z-10">
                                <div class="text-2xl font-mono font-bold text-slate-900 dark:text-white">6,890.12</div>
                                <div class="text-sm font-bold text-up flex items-center gap-1"><i data-lucide="trending-up" class="w-3 h-3"></i> +0.45%</div>
                            </div>
                            <div id="ihsg-chart" class="w-full h-full rounded-lg"></div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-slate-900 dark:text-white">Saham Pilihan</h3>
                        <div class="flex gap-2 text-xs">
                            <button class="px-2 py-1 bg-slate-200 dark:bg-slate-800 rounded text-slate-600 dark:text-slate-300">Saham LQ45</button>
                            <button class="px-2 py-1 bg-slate-200 dark:bg-slate-800 rounded text-slate-600 dark:text-slate-300">Gainers</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        ${MARKET_DATA.idx.map(s => `
                            <div class="glass-panel p-4 rounded-xl border border-slate-200 dark:border-slate-800 stock-card ${s.change >= 0 ? 'up' : 'down'} cursor-pointer">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-bold text-slate-900 dark:text-white text-lg">${s.id}</div>
                                        <div class="text-xs text-slate-500 truncate w-24">${s.name}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-mono font-bold text-slate-900 dark:text-white live-price" data-price="${s.price}" data-type="idx">${s.price}</div>
                                        <div class="text-xs font-bold ${s.change >= 0 ? 'text-up' : 'text-down'}">${s.change > 0 ? '+' : ''}${s.change}%</div>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-3">
                                    <button class="flex-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-2 rounded">Beli</button>
                                    <button class="flex-1 bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded">Jual</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        function getNewsDashboard() {
            // News based on API Key
            const hasKey = AppState.apiKeys.news !== '';
            const newsList = hasKey ? 
                [
                    {title:'Bank Indonesia Naikkan Suku Bunga, IHSG Melemah', source:'CNN Indonesia', time:'10 menit lalu'},
                    {title:'Bitcoin Tembus $100k, Whales Mulai Akumulasi', source:'CoinDesk', time:'30 menit lalu'},
                    {title:'Emiten Batubara ANTM Cetak Laba Bersih Rp 5T', source:'Kontan', time:'1 jam lalu'},
                    {title:'Ethereum Upgrade "Pectra" Akan Dimulai Bulan Depan', source:'CryptoPotato', time:'2 jam lalu'}
                ] : [
                    {title:'[DEMO] Pasar Saham Indonesia Menguat di Awal Pekan', source:'Demo News', time:'Baru saja'},
                    {title:'[DEMO] Harga Emas Antam Turun Tipis Hari Ini', source:'Demo News', time:'1 jam lalu'}
                ];

            return `
                <div class="max-w-3xl mx-auto animate-fade-up pb-4">
                    <h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Berita Pasar ${hasKey ? '(Live)' : '(Demo)'}</h2>
                    <div class="space-y-4">
                        ${newsList.map(n => `
                            <div class="glass-panel p-4 rounded-xl border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition cursor-pointer">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-100 text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase">${n.source}</span>
                                    <span class="text-xs text-slate-500">${n.time}</span>
                                </div>
                                <h3 class="font-bold text-slate-900 dark:text-white mb-1">${n.title}</h3>
                                <p class="text-sm text-slate-500 line-clamp-2">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua...</p>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        function getProfile() {
            const u = AppState.currentUser;
            return `
                <div class="max-w-xl mx-auto animate-fade-up pb-4">
                    <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white">Profil & Dompet</h2>
                    
                    <!-- SALDO CARD -->
                    <div class="glass-panel p-6 rounded-xl border border-blue-500/30 bg-gradient-to-r from-blue-600 to-cyan-600 text-white border-none mb-6 shadow-xl">
                        <div class="text-sm opacity-80">Saldo Rupiah Tersedia</div>
                        <div class="text-3xl font-bold font-mono mt-1">Rp ${u.balance.toLocaleString('id-ID')}</div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="switchDash('idx')" class="flex-1 bg-white/20 hover:bg-white/30 text-white text-xs font-bold py-2 rounded backdrop-blur">Isi Saldo</button>
                            <button onclick="document.getElementById('wd-section').classList.toggle('hidden')" class="flex-1 bg-white/20 hover:bg-white/30 text-white text-xs font-bold py-2 rounded backdrop-blur">Tarik Dana</button>
                        </div>
                    </div>

                    <!-- PENCAIRAN FORM -->
                    <div id="wd-section" class="hidden glass-panel p-6 rounded-xl border border-slate-200 dark:border-slate-800 mb-6">
                        <h3 class="font-bold text-slate-900 dark:text-white mb-4 border-b border-slate-700 pb-2">Form Pencairan Dana</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold">Bank Tujuan</label>
                                <select id="wdBank" class="w-full glass-input rounded px-3 py-2">
                                    <option>BCA - 1234567890</option>
                                    <option>BRI - 9876543210</option>
                                    <option>MANDIRI - 1122334455</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold">Jumlah Pencairan (Rp)</label>
                                <input type="number" id="wdAmount" placeholder="Min Rp 50.000" class="w-full glass-input rounded px-3 py-2">
                            </div>
                            <button onclick="requestWithdrawal()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg">Ajukan Pencairan</button>
                        </div>
                    </div>

                    <!-- EDIT PROFILE -->
                    <div class="glass-panel p-6 rounded-xl border border-slate-200 dark:border-slate-800 space-y-5">
                        <div class="flex flex-col items-center">
                            <div class="relative mb-3">
                                <img id="avatar-preview" src="${u.avatar}" class="w-24 h-24 rounded-full border-4 border-slate-200 dark:border-slate-700 object-cover">
                                <label class="absolute bottom-0 right-0 bg-blue-600 p-2 rounded-full text-white cursor-pointer hover:bg-blue-500 shadow-lg border-2 border-white dark:border-slate-900">
                                    <i data-lucide="camera" class="w-4 h-4"></i>
                                    <input type="file" class="hidden" accept="image/*" onchange="previewAvatar(event)">
                                </label>
                            </div>
                            <div class="font-bold text-lg text-slate-900 dark:text-white">${u.username}</div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Nama Lengkap</label>
                            <input id="pName" value="${u.fullName}" class="w-full glass-input rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Email</label>
                            <input id="pEmail" value="${u.email}" class="w-full glass-input rounded px-3 py-2">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs text-slate-500 uppercase font-bold">Password Baru</label><input id="pPass" placeholder="Opsional" type="password" class="w-full glass-input rounded px-3 py-2"></div>
                            <div><label class="text-xs text-slate-500 uppercase font-bold">PIN Baru (6)</label><input id="pPin" placeholder="Opsional" maxlength="6" class="w-full glass-input rounded px-3 py-2"></div>
                        </div>
                        <button onclick="saveProfile()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">Simpan Profil</button>
                    </div>
                </div>`;
        }

        function getAdminDashboard() {
            const users = db.get(DB_KEYS.USERS);
            return `
                <div class="max-w-6xl mx-auto animate-fade-up pb-4">
                    <div class="flex items-center gap-2 mb-6 text-purple-500 font-bold text-xl"><i data-lucide="shield"></i> Admin Dashboard</div>
                    
                    <!-- API KEYS -->
                    <div class="glass-panel p-6 rounded-xl border border-purple-500/30 mb-6">
                        <h3 class="font-bold text-slate-900 dark:text-white mb-4">Konfigurasi API Key (Real-time Data)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold">Saham IDX API</label>
                                <input id="kStock" value="${AppState.apiKeys.stock}" class="w-full glass-input rounded px-3 py-2 font-mono text-xs mt-1">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold">Crypto API (Binance/Coingecko)</label>
                                <input id="kCrypto" value="${AppState.apiKeys.crypto}" class="w-full glass-input rounded px-3 py-2 font-mono text-xs mt-1">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold">News API</label>
                                <input id="kNews" value="${AppState.apiKeys.news}" class="w-full glass-input rounded px-3 py-2 font-mono text-xs mt-1">
                            </div>
                        </div>
                        <button onclick="saveAdminSettings()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded-lg mt-4">Simpan Konfigurasi</button>
                    </div>

                    <!-- USER MANAGEMENT -->
                    <div class="glass-panel p-6 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden">
                        <h3 class="font-bold text-slate-900 dark:text-white mb-4">Manajemen Pengguna</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-slate-500">
                                <thead class="bg-slate-100 dark:bg-slate-800 text-xs uppercase font-bold text-slate-700 dark:text-slate-300">
                                    <tr><th class="px-4 py-3">Username</th><th class="px-4 py-3">Email</th><th class="px-4 py-3">Saldo</th><th class="px-4 py-3">Status</th><th class="px-4 py-3 text-right">Aksi</th></tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                                    ${users.map(u => `
                                        <tr>
                                            <td class="px-4 py-3 font-bold text-slate-900 dark:text-white">${u.username} ${u.role==='admin'?'<span class="text-xs bg-purple-100 text-purple-600 px-1 rounded">ADMIN</span>':''}</td>
                                            <td class="px-4 py-3">${u.email}</td>
                                            <td class="px-4 py-3 font-mono">Rp ${u.balance.toLocaleString('id-ID')}</td>
                                            <td class="px-4 py-3">
                                                ${u.isBanned 
                                                    ? '<span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">BANNED</span>' 
                                                    : '<span class="bg-green-100 text-green-600 px-2 py-1 rounded text-xs font-bold">AKTIF</span>'}
                                            </td>
                                            <td class="px-4 py-3 text-right">
                                                ${u.role !== 'admin' ? `
                                                    <button onclick="toggleUserStatus('${u.id}')" class="text-xs font-bold px-3 py-1 rounded ${u.isBanned ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-red-600 hover:bg-red-500 text-white'}">
                                                        ${u.isBanned ? 'Unban' : 'Ban'}
                                                    </button>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }

        // --- CHARTS ---
        function initCharts() {
            // IHSG Chart
            if(AppState.dashView === 'idx') {
                const c = document.getElementById('ihsg-chart'); if(!c) return;
                c.innerHTML='';
                const chart = LightweightCharts.createChart(c, {
                    layout: { background: { color: 'transparent' }, textColor: '#64748b' },
                    grid: { vertLines: { visible: false }, horzLines: { color: 'rgba(255,255,255,0.05)' } },
                    timeScale: { visible: false }, rightPriceScale: { borderVisible: false }
                });
                const series = chart.addAreaSeries({ 
                    lineColor: '#0ecb81', topColor: 'rgba(14, 203, 129, 0.4)', bottomColor: 'rgba(14, 203, 129, 0)' 
                });
                const data = []; let time = Math.floor(Date.now()/1000)-86400, price=6800;
                for(let i=0;i<60;i++){ 
                    price = price + (Math.random()-0.4)*5; 
                    data.push({time:time+i*600, value:price}); 
                }
                series.setData(data); chart.timeScale().fitContent();
            }
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = AppState.currentUser ? Dashboard() : AuthView();
            setTimeout(() => lucide.createIcons(), 50);
        }

        render();
    </script>
</body>
</html>